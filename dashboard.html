<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href=dashboard.css">
</head>
<body>
  <div class="dashboard" id="admin-content">
    <!-- Header -->
    <div class="dashboard-header">
      <h1 class="dashboard-title">Admin Dashboard</h1>
      <div class="header-actions">
        <button class="btn btn-primary">
          <i class="fas fa-cog"></i>
          Settings
        </button>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="cards">
      <div class="card total-users">
        <h3>Total Users</h3>
        <p id="userCount">0</p>
        <div class="card-trend">
          <i class="fas fa-arrow-up text-success"></i>
          <span>12% from last month</span>
        </div>
      </div>
      <div class="card total-transactions">
        <h3>Total Transactions</h3>
        <p id="transactionCount">0</p>
        <div class="card-trend">
          <i class="fas fa-arrow-up text-success"></i>
          <span>24% from last month</span>
        </div>
      </div>
      <div class="card total-earnings">
        <h3>Total Earnings</h3>
        <p id="amountSum">₹0</p>
        <div class="card-trend">
          <i class="fas fa-arrow-up text-success"></i>
          <span>18% from last month</span>
        </div>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="quick-links">
      <h3 class="section-title">Quick Actions</h3>
      <div class="grid-container">
        <div class="grid-card" onclick="location.href='pay-history.html'">
          <div class="icon-text">
            <i class="fas fa-exchange-alt icon" style="font-size: 1.5rem;"></i>
            <h4>View Transactions</h4>
          </div>
        </div>
        <div class="grid-card" onclick="location.href='users-list.html'">
          <div class="icon-text">
            <i class="fas fa-users icon" style="font-size: 1.5rem;"></i>
            <h4>View Users</h4>
          </div>
        </div>
        <div class="grid-card" onclick="location.href='brijesh.html'">
          <div class="icon-text">
            <i class="fas fa-check-circle icon" style="font-size: 1.5rem;"></i>
            <h4>Confirm Transactions</h4>
          </div>
        </div>
        <div class="grid-card" onclick="location.href='upi-setting.html'">
          <div class="icon-text">
            <i class="fas fa-cog icon" style="font-size: 1.5rem;"></i>
            <h4>Update UPI</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts">
      <div class="chart-container">
        <h3>User Growth</h3>
        <canvas id="userChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Transaction Distribution</h3>
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast">
    <i class="fas fa-check-circle toast-icon"></i>
    <div class="toast-content">Action completed successfully!</div>
  </div>

  <script src="script.js"></script>
  <script>
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAgjEBxPifW0W3o7CtLfRZ9mXnHoMbibao",
  authDomain: "mines-botai.firebaseapp.com",
  databaseURL: "https://mines-botai-default-rtdb.firebaseio.com",
  projectId: "mines-botai",
  storageBucket: "mines-botai.firebasestorage.app",
  messagingSenderId: "175710322906",
  appId: "1:175710322906:web:94470ebbc40336f6dfe5e3",
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load Transactions
  const transactionsRef = ref(db, "transactions");
  onValue(transactionsRef, (snapshot) => {
    let totalAmount = 0;
    let totalCount = 0;
    let success = 0, pending = 0, failed = 0;

    snapshot.forEach((child) => {
      const tx = child.val();
      if (!isNaN(parseFloat(tx.amount))) {
        totalAmount += parseFloat(tx.amount);
      }
      totalCount++;
      const status = (tx.status || "").toLowerCase();
      if (status === "success") success++;
      else if (status === "pending") pending++;
      else failed++;
    });

    document.getElementById("transactionCount").textContent = totalCount;
    document.getElementById("amountSum").textContent = "₹" + totalAmount.toLocaleString();
    renderPieChart(success, pending, failed);
  }, { onlyOnce: true });
}

      // Load Users
  const usersRef = ref(db, "users");
  onValue(usersRef, (snapshot) => {
    const users = snapshot.val();
    const count = users ? Object.keys(users).length : 0;
    const userCountEl = document.getElementById("userCount");
    if (userCountEl) userCountEl.textContent = count;

    if (users) {
      Object.values(users).forEach(user => {
        const timestamp = parseInt(user.createdAt || user.timestamp);
        if (!isNaN(timestamp)) {
          const date = new Date(timestamp);
          const month = date.toLocaleString('default', { month: 'short' });
          if (monthWiseUsers[month] !== undefined) {
            monthWiseUsers[month]++;
          }
        }
      });
    }                        
      // User Growth Chart
      const userCtx = document.getElementById('userChart').getContext('2d');
      const userChart = new Chart(userCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'New Users',
            data: [120, 190, 170, 220, 260, 300],
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            borderColor: 'rgba(67, 97, 238, 1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Pie Chart
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      const pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels: ['Completed', 'Pending', 'Failed'],
          datasets: [{
            data: [300, 50, 20],
            backgroundColor: [
              'rgba(76, 201, 240, 0.8)',
              'rgba(248, 150, 30, 0.8)',
              'rgba(247, 37, 133, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
            }
          },
          cutout: '70%'
        }
      });

      // Sample data for cards
      document.getElementById('userCount').textContent = '1,248';
      document.getElementById('transactionCount').textContent = '370';
      document.getElementById('amountSum').textContent = '₹84,560';

      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', function() {
        showToast('Logout successful!');
        signOut(auth).then(() => {
          window.location.href = "admin-login.html";
        }).catch((error) => {
          alert("Logout failed: " + error.message);
        });
      });
    

// Toast Function
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.className = 'toast-success';
  toast.querySelector('.toast-icon').className = 'fas fa-check-circle toast-icon';
  toast.querySelector('.toast-content').textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}
  </script>
</body>
</html>
