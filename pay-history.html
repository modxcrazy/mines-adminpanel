<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All Transactions History</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- CSS Start --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }
    body {
      display: flex;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
   
    .main-content {
      flex: 1;
      padding: 20px 30px;
      background: inherit;
      color: inherit;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .notification-bell {
      position: relative;
    }
    #notifIcon {
      font-size: 24px;
      cursor: pointer;
    }
    .notif-popup {
      display: none;
      position: absolute;
      right: 0;
      top: 30px;
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 14px;
    }
    .card {
      background: #292929;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .card h3 {
      margin-bottom: 15px;
    }
    .form-group {
      margin-bottom: 12px;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: none;
      background: #444;
      color: white;
    }
    .txn-table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
      background: #1e1e1e;
    }
    .txn-table th, .txn-table td {
      padding: 12px;
      border: 1px solid #333;
      text-align: left;
    }
    .txn-table th {
      background: #333;
    }
    .btn-delete {
      background: #ff4d4d;
      color: white;
      padding: 6px 10px;
      margin-left: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-delete:hover {
      background: #e60000;
    }
    .approve-btn, .reject-btn, #saveUpiBtn {
      padding: 6px 14px;
      margin: 3px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    .approve-btn {
      background: #28a745;
      color: white;
    }
    .reject-btn {
      background: #dc3545;
      color: white;
    }
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #28a745;
      color: white;
      padding: 12px 18px;
      border-radius: 5px;
      display: none;
      font-size: 16px;
      z-index: 9999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    /* --- CSS End --- */
  </style>
</head>
<body class="dark-theme">

  <div class="main-content">
    <div class="top-bar">
      <h2>All Transactions History</h2>
      <div class="notification-bell">
        <span id="notifIcon">ðŸ””</span>
        <div id="notifPopup" class="notif-popup">New transaction received!</div>
      </div>
    </div>

    <table class="txn-table">
      <thead>
        <tr>
          <th>UTR Number</th>
          <th>Amount</th>
          <th>App</th>
          <th>Date</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="transactionBody"></tbody>
    </table>

    <canvas id="statusChart" height="100"></canvas>
  </div>

  <div id="toast" class="toast">Approved successfully!</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCn553qWsVz2VF1dZ4Ji5OkQDGFvMORbJE",
      authDomain: "pg-data-ed1c2.firebaseapp.com",
      databaseURL: "https://pg-data-ed1c2-default-rtdb.firebaseio.com",
      projectId: "pg-data-ed1c2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = "admin-login.html";
    });

    const transactions = [];
    let previousTransactionCount = 0;
    const notificationSound = new Audio("https://www.soundjay.com/buttons/sounds/button-29.mp3");
    notificationSound.load();

    const transactionsRef = ref(db, "transactions");
    onValue(transactionsRef, snapshot => {
      const data = snapshot.val();
      if (!data) return;
      const newKeys = Object.keys(data);
      if (newKeys.length > previousTransactionCount) {
        playNotificationEffects();
        showNotificationPopup("New transaction received!");
      }
      previousTransactionCount = newKeys.length;
      transactions.length = 0;
      newKeys.forEach(key => transactions.push({ id: key, ...data[key] }));
      renderTransactions();
    });

    function renderTransactions() {
      const tbody = document.getElementById("transactionBody");
      tbody.innerHTML = "";
      transactions.forEach(txn => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${txn.utr}</td>
          <td>â‚¹${txn.amount}</td>
          <td>${txn.app || 'N/A'}</td>
          <td>${txn.date}</td>
          <td>${txn.status}</td>
          <td>
            <button class="approve-btn" onclick="updateStatus('${txn.id}', 'Approved')">Approve</button>
            <button class="reject-btn" onclick="updateStatus('${txn.id}', 'Rejected')">Reject</button>
            <button class="btn-delete" onclick="deleteTransaction('${txn.id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      updateChart();
    }

    window.updateStatus = (id, status) => {
      update(ref(db, "transactions/" + id), { status }).then(() => showToast(`${status} successfully!`));
    };

    window.deleteTransaction = (id) => {
      if (confirm("Are you sure you want to delete this transaction?")) {
        remove(ref(db, `transactions/${id}`)).then(() => showToast("Transaction deleted!"))
        .catch(error => console.error("Delete failed:", error));
      }
    };

    function updateChart() {
      const counts = transactions.reduce((acc, t) => {
        acc[t.status] = (acc[t.status] || 0) + 1;
        return acc;
      }, {});
      const ctx = document.getElementById("statusChart").getContext("2d");
      if (window.statusChart) window.statusChart.destroy();
      window.statusChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Approved', 'Rejected', 'Pending'],
          datasets: [{
            data: [counts['Approved'] || 0, counts['Rejected'] || 0, counts['Pending'] || 0],
            backgroundColor: ['#28a745', '#e74c3c', '#ffc107']
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          responsive: true
        }
      });
    }

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerHTML = `<span class="tick">âœ”</span> ${msg}`;
      toast.style.display = "block";
      setTimeout(() => (toast.style.display = "none"), 3000);
    }

    function showNotificationPopup(msg = "New transaction received!") {
      const popup = document.getElementById("notifPopup");
      popup.textContent = msg;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 4000);
    }

    function playNotificationEffects() {
      notificationSound.play().catch(e => console.warn("Audio play error:", e));
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }
  </script>
</body>
</html>
